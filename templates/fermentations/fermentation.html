{% extends "base.html" %}

{% block title %}Fermentaciones{% endblock %}

{% block content %}
<div class="container mt-5">
    <h2 class="mb-4">Fermentaciones</h2>

    <!-- Botón para abrir modal agregar -->
    <button class="btn btn-success mb-3" data-bs-toggle="modal" data-bs-target="#addModal">Agregar Fermentación</button>

    <!-- Tabla listado fermentaciones -->
    <table class="table table-bordered table-striped">
        <thead>
            <tr>
                <th>ID</th>
                <th>Fecha Inicio</th>
                <th>Fecha Fin</th>
                <th>Temperatura (°C)</th>
                <th>Acidez</th>
                <th>pH</th>
                <th>Notas</th>
                <th>Acciones</th>
            </tr>
        </thead>
        <tbody>
            {% for f in fermentations %}
            <tr>
                <td>{{ f.id }}</td>
                <td>{{ f.start_date }}</td>
                <td>{{ f.end_date or '-' }}</td>
                <td>{{ f.temperature if f.temperature is not none else '-' }}</td>
                <td>{{ f.acidity if f.acidity is not none else '-' }}</td>
                <td>{{ f.ph if f.ph is not none else '-' }}</td>
                <td>{{ f.notes or '-' }}</td>
                <td>
                    <button class="btn btn-primary btn-sm btn-edit" 
                        data-id="{{ f.id }}"
                        data-start_date="{{ f.start_date }}"
                        data-end_date="{{ f.end_date }}"
                        data-temperature="{{ f.temperature }}"
                        data-acidity="{{ f.acidity }}"
                        data-ph="{{ f.ph }}"
                        data-notes="{{ f.notes|e }}"
                        data-bs-toggle="modal" data-bs-target="#editModal">Editar</button>

                    <form method="POST" action="{{ url_for('fermentations.delete_fermentation', id=f.id) }}" style="display:inline-block" onsubmit="return confirm('¿Eliminar fermentación ID {{ f.id }}?');">
                        <button class="btn btn-danger btn-sm" type="submit">Eliminar</button>
                    </form>
                </td>
            </tr>
            {% else %}
            <tr><td colspan="8" class="text-center">No hay fermentaciones registradas.</td></tr>
            {% endfor %}
        </tbody>
    </table>
</div>

<!-- Modal Agregar -->
<div class="modal fade" id="addModal" tabindex="-1" aria-labelledby="addModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <form method="POST" action="{{ url_for('fermentations.add_fermentation') }}">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="addModalLabel">Agregar Fermentación</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
        </div>
        <div class="modal-body">
            <div class="mb-3">
                <label for="add-start_date" class="form-label">Fecha de inicio *</label>
                <input type="date" id="add-start_date" name="start_date" class="form-control" required>
            </div>
            <div class="mb-3">
                <label for="add-end_date" class="form-label">Fecha de fin</label>
                <input type="date" id="add-end_date" name="end_date" class="form-control">
            </div>
            <div class="mb-3">
                <label for="add-temperature" class="form-label">Temperatura (°C)</label>
                <input type="number" step="0.1" id="add-temperature" name="temperature" class="form-control">
            </div>
            <div class="mb-3">
                <label for="add-acidity" class="form-label">Acidez</label>
                <input type="number" step="0.01" id="add-acidity" name="acidity" class="form-control">
            </div>
            <div class="mb-3">
                <label for="add-ph" class="form-label">pH</label>
                <input type="number" step="0.01" id="add-ph" name="ph" class="form-control">
            </div>
            <div class="mb-3">
                <label for="add-notes" class="form-label">Notas</label>
                <textarea id="add-notes" name="notes" class="form-control" rows="3"></textarea>
            </div>
        </div>
        <div class="modal-footer">
          <button type="submit" class="btn btn-success">Guardar</button>
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
        </div>
      </div>
    </form>
  </div>
</div>

<!-- Modal Editar -->
<div class="modal fade" id="editModal" tabindex="-1" aria-labelledby="editModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <form method="POST" id="editForm">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="editModalLabel">Editar Fermentación</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
        </div>
        <div class="modal-body">
            <input type="hidden" name="id" id="edit-id">
            <div class="mb-3">
                <label for="edit-start_date" class="form-label">Fecha de inicio *</label>
                <input type="date" id="edit-start_date" name="start_date" class="form-control" required>
            </div>
            <div class="mb-3">
                <label for="edit-end_date" class="form-label">Fecha de fin</label>
                <input type="date" id="edit-end_date" name="end_date" class="form-control">
            </div>
            <div class="mb-3">
                <label for="edit-temperature" class="form-label">Temperatura (°C)</label>
                <input type="number" step="0.1" id="edit-temperature" name="temperature" class="form-control">
            </div>
            <div class="mb-3">
                <label for="edit-acidity" class="form-label">Acidez</label>
                <input type="number" step="0.01" id="edit-acidity" name="acidity" class="form-control">
            </div>
            <div class="mb-3">
                <label for="edit-ph" class="form-label">pH</label>
                <input type="number" step="0.01" id="edit-ph" name="ph" class="form-control">
            </div>
            <div class="mb-3">
                <label for="edit-notes" class="form-label">Notas</label>
                <textarea id="edit-notes" name="notes" class="form-control" rows="3"></textarea>
            </div>
        </div>
        <div class="modal-footer">
          <button type="submit" class="btn btn-primary">Actualizar</button>
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
        </div>
      </div>
    </form>
  </div>
</div>

<!-- JS para llenar formulario editar -->
<script>
document.addEventListener("DOMContentLoaded", function() {
    const editModal = document.getElementById('editModal');
    editModal.addEventListener('show.bs.modal', function (event) {
        const button = event.relatedTarget;
        const id = button.getAttribute('data-id');
        const start_date = button.getAttribute('data-start_date');
        const end_date = button.getAttribute('data-end_date');
        const temperature = button.getAttribute('data-temperature');
        const acidity = button.getAttribute('data-acidity');
        const ph = button.getAttribute('data-ph');
        const notes = button.getAttribute('data-notes');

        document.getElementById('edit-id').value = id;
        document.getElementById('edit-start_date').value = start_date || '';
        document.getElementById('edit-end_date').value = end_date || '';
        document.getElementById('edit-temperature').value = temperature || '';
        document.getElementById('edit-acidity').value = acidity || '';
        document.getElementById('edit-ph').value = ph || '';
        document.getElementById('edit-notes').value = notes || '';

        const form = document.getElementById('editForm');
        form.action = `/fermentations/edit/${id}`;
    });
});
</script>
{% endblock %}
